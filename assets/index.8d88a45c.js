var q=Object.defineProperty;var K=(c,t,e)=>t in c?q(c,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[t]=e;var i=(c,t,e)=>(K(c,typeof t!="symbol"?t+"":t,e),e);import{C as D,V as w,a as d,G as U,B as F,M as H,b as W,c as k,N as $,T as Q,d as J,D as tt,e as et,S as it,O as st,f as j,g as ot,P as rt,W as nt,E as at,R as ht,A as ct,h as lt,i as dt,j as ut,k as _t,l as ft,m as pt,n as mt}from"./vendor.b0aee4a7.js";const wt=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const h of r.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&o(h)}).observe(document,{childList:!0,subtree:!0});function e(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerpolicy&&(r.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?r.credentials="include":s.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(s){if(s.ep)return;s.ep=!0;const r=e(s);fetch(s.href,r)}};wt();new w(0,1,0);new w(1,0,0);new w(0,0,1);const gt=new D(.9,.9,.9),B=new D("red"),xt=new D("green"),yt=new D("blue"),g="TOOL_DONE",S="TOOL_CLOSING",x="TOOL_BUSY",V="TOOL_SKIP";class bt{constructor(t){i(this,"_activeStack");i(this,"_closingList");i(this,"_nextTool");i(this,"_idletool");i(this,"setNextTool",t=>{this._nextTool=t});i(this,"_updateActiveTool",(t,e)=>{const o=this.activeTool;switch(o.update(!1,t,e)){case x:break;case V:this._idletool.update(!1,t,e);break;case g:this._activeStack.pop(),e.hud.logInfo(`TOOL [${o.getName()}] done`);break;case S:e.hud.logInfo(`TOOL [${o.getName()}] closing`),this._activeStack.pop(),this._closingList.push(o);break}this._nextTool!==void 0&&(this._activeStack.push(this._nextTool),this._nextTool=void 0),this._activeStack.length===0&&this._activeStack.push(this._idletool)});i(this,"_updateClosingTools",(t,e)=>{for(const o of[...this._closingList])switch(o.update(!0,t,e)){case x:break;case g:const r=this._closingList.indexOf(o);this._closingList.splice(r,1),e.hud.logInfo(`TOOL [${o.getName()}] done`);break}});this._idletool=t(this.setNextTool),this._activeStack=[this._idletool],this._closingList=[],this._nextTool=void 0}get activeTool(){return this._activeStack[this._activeStack.length-1]}update(t,e){e.hud.showNow("TOOLS "+this._activeStack.map(o=>o.getName()).join("; ")),e.hud.showNow("CLOSING "+this._closingList.map(o=>o.getName()).join("; ")),this._updateActiveTool(t,e),this._updateClosingTools(t,e)}get isIdle(){return this.activeTool===this._idletool}}class Tt{constructor(t,e,o,s,r,h,a){i(this,"_start");i(this,"_pan");i(this,"_dirtyCallback");i(this,"_firstUpdate");i(this,"_zoom");i(this,"getName",()=>"Panning");i(this,"update",(t,e,{interactions:o,hud:s})=>t?g:this._firstUpdate?(this._firstUpdate=!1,x):o.leftReleased===!0?(o.mousePos.distanceTo(this._start),g):(s.setCursor("grabbing"),this._pan.add(new d(-(o.mouseDelta.x/this._viewportWidth)*this._worldWidth/this._zoom,-(o.mouseDelta.y/this._viewportWidth)*this._worldWidth/this._zoom)),this._dirtyCallback(),x));this._start=e.clone(),this._pan=o,this._zoom=s,this._dirtyCallback=a,this._firstUpdate=!0,this._viewportWidth=r,this._worldWidth=h,t.logInfo(`PanningTool from ${e.x},${e.y}`)}}class vt{constructor(t,e){i(this,"w");i(this,"h");i(this,"data");this.w=t,this.h=e,this.data=[];for(let o=0;o<this.w;o++){this.data.push([]);for(let s=0;s<this.h;s++)this.data[o].push(0)}}get(t,e){return t>=this.w||e>=this.h||t<0||e<0?null:this.data[t][e]}brush(t,e,o){const s=Math.ceil(e/2),r=new d;for(let h=t.x-s;h<t.x+s;h++)for(let a=t.y-s;a<t.y+s;a++){if(h>=this.w||a>=this.h||h<0||a<0)continue;r.set(h,a);const l=t.distanceTo(r),n=Math.min(Math.max(1-l/s,0),1);this.data[h][a]+=o*n}}}const G=3,Y=2,N=3;class Pt{constructor(t){i(this,"object3d");i(this,"_group");i(this,"_texture");i(this,"_textureDepth");i(this,"_mesh");i(this,"_positionBuffer");i(this,"_uvBuffer");i(this,"_positionAttribute");i(this,"_uvAttribute");i(this,"update",()=>{const t=this._positionBuffer,e=this._uvBuffer,o={tl:new d(0,1),tr:new d(1,1),bl:new d(0,0),br:new d(1,0)};let s=0,r=0;const h=5,a=5,l=0,n=1,p=1;t[s++]=h,t[s++]=l,t[s++]=a,e[r++]=o.bl.x,e[r++]=o.bl.y,t[s++]=h+n,t[s++]=l,t[s++]=a-n,e[r++]=o.br.x,e[r++]=o.br.y,t[s++]=h,t[s++]=l+p,t[s++]=a,e[r++]=o.tl.x,e[r++]=o.tl.y,t[s++]=h,t[s++]=l+p,t[s++]=a,e[r++]=o.tl.x,e[r++]=o.tl.y,t[s++]=h+n,t[s++]=l,t[s++]=a-n,e[r++]=o.br.x,e[r++]=o.br.y,t[s++]=h+n,t[s++]=l+p,t[s++]=a-n,e[r++]=o.tr.x,e[r++]=o.tr.y,this._positionAttribute.needsUpdate=!0,this._uvAttribute.needsUpdate=!0,this._mesh.geometry.computeVertexNormals(),this._mesh.geometry.computeBoundingBox(),this._mesh.geometry.computeBoundingSphere()});this._group=new U,this._texture=t.cube_colour,this._textureDepth=t.cube_depth;const e=new F,o=new H({name:"FunnyDepthMaterial",map:this._texture});o.onBeforeCompile=s=>{console.log({shader:s}),s.uniforms.map_depth={value:this._textureDepth},s.fragmentShader=s.fragmentShader.replace("#include <common>",`#include <common>
              uniform sampler2D map_depth;`).replace("#include <fog_fragment>",`#include <fog_fragment>
                vec4 texelMapDepth = texture2D( map_depth, vUv );
                texelMapDepth = mapTexelToLinear( texelMapDepth );
                gl_FragDepth = 0.1 * texelMapDepth.g;
            `)},this._mesh=new W(e,o),this._group.add(this._mesh),this.object3d=this._group,this.resizeBuffersForQuads(1)}resizeBuffersForQuads(t){const e=t*2,o=new Float32Array(e*N*G);for(let r in this._positionBuffer)o[r]=this._positionBuffer[r];this._positionBuffer=o;const s=new Float32Array(e*N*Y);for(let r in this._uvBuffer)s[r]=this._uvBuffer[r];this._uvBuffer=s,this._positionAttribute=new k(this._positionBuffer,G),this._mesh.geometry.setAttribute("position",this._positionAttribute),this._uvAttribute=new k(this._uvBuffer,Y),this._mesh.geometry.setAttribute("uv",this._uvAttribute),this._mesh.geometry.setDrawRange(0,e*N)}}const I=3,Z=2,R=3;class Dt{constructor(t){i(this,"object3d");i(this,"_group");i(this,"_texture");i(this,"_mesh");i(this,"_positionBuffer");i(this,"_uvBuffer");i(this,"_positionAttribute");i(this,"_uvAttribute");i(this,"update",t=>{const e=t.w*t.h*2,o=this._positionAttribute.array.length/I/R;e>o&&(console.log("resizing to ",e),this.resizeBuffers(e));let s=0,r=0;const h=this._positionBuffer,a=this._uvBuffer;for(let l=0;l<t.h-1;l++)for(let n=0;n<t.w-1;n++){const p=t.get(n,l),_=t.get(n+1,l),m=t.get(n,l+1),y=t.get(n+1,l+1),f={tl:new d(0,1),tr:new d(1,1),bl:new d(0,0),br:new d(1,0)};h[s++]=n,h[s++]=p,h[s++]=l,a[r++]=f.tl.x,a[r++]=f.tl.y,h[s++]=n,h[s++]=m,h[s++]=l+1,a[r++]=f.bl.x,a[r++]=f.bl.y,h[s++]=n+1,h[s++]=_,h[s++]=l,a[r++]=f.tr.x,a[r++]=f.tr.y,h[s++]=n+1,h[s++]=y,h[s++]=l+1,a[r++]=f.br.x,a[r++]=f.br.y,h[s++]=n+1,h[s++]=_,h[s++]=l,a[r++]=f.tr.x,a[r++]=f.tr.y,h[s++]=n,h[s++]=m,h[s++]=l+1,a[r++]=f.bl.x,a[r++]=f.bl.y}this._positionAttribute.needsUpdate=!0,this._uvAttribute.needsUpdate=!0,this._mesh.geometry.computeVertexNormals(),this._mesh.geometry.computeBoundingBox(),this._mesh.geometry.computeBoundingSphere()});i(this,"raycast",t=>{const e=[];return this._mesh.raycast(t,e),e});this._group=new U,this._texture=t.tileset,this._texture.magFilter=$,this._texture.minFilter=$;const e=new F,o=new H({map:this._texture});this._mesh=new W(e,o),this._group.add(this._mesh),this.object3d=this._group,this.resizeBuffers(1)}resizeBuffers(t){const e=new Float32Array(t*R*I);for(let s in this._positionBuffer)e[s]=this._positionBuffer[s];this._positionBuffer=e;const o=new Float32Array(t*R*Z);for(let s in this._uvBuffer)o[s]=this._uvBuffer[s];this._uvBuffer=o,this._positionAttribute=new k(this._positionBuffer,I),this._mesh.geometry.setAttribute("position",this._positionAttribute),this._uvAttribute=new k(this._uvBuffer,Z),this._mesh.geometry.setAttribute("uv",this._uvAttribute),this._mesh.geometry.setDrawRange(0,t*R)}}new w(0,0,0);new w(1,0,0);new w(0,0,1);new w(1,0,1);class kt{constructor(){i(this,"firstUpdate");i(this,"mousePosPrevious");i(this,"mousePos");i(this,"mouseDelta");i(this,"wheelDelta");i(this,"wheelDeltaTemp");i(this,"leftDown");i(this,"leftPressed");i(this,"leftReleased");i(this,"leftClicked");i(this,"leftDownTime");i(this,"leftUpTime");i(this,"leftDownPos");i(this,"leftUpPos");i(this,"rightDown");i(this,"rightPressed");i(this,"rightReleased");i(this,"rightClicked");i(this,"rightDownTime");i(this,"rightUpTime");i(this,"rightDownPos");i(this,"rightUpPos");i(this,"shiftDown");i(this,"shiftDownTemp");this.firstUpdate=!0,this.mousePosPrevious=new d(0,0),this.mousePos=new d(0,0),this.mouseDelta=new d(0,0),this.leftDown=!1,this.leftClicked=!1,this.leftDownTime=new Date,this.leftUpTime=new Date,this.leftDownPos=new d(0,0),this.leftUpPos=new d(0,0),this.rightDown=!1,this.rightClicked=!1,this.rightDownTime=new Date,this.rightUpTime=new Date,this.rightDownPos=new d(0,0),this.rightUpPos=new d(0,0),this.wheelDelta=new d(0,0),this.wheelDeltaTemp=new d(0,0),this.shiftDown=!1,this.shiftDownTemp=!1}install(t){t.addEventListener("mousemove",e=>{this.mousePos.set(e.clientX,e.clientY)}),t.addEventListener("click",e=>{e.preventDefault(),console.log("click",e.type,e.button,e.buttons)}),t.addEventListener("mousedown",e=>{e.preventDefault(),console.log("mousedown",e.type,e.button,e.buttons),e.button===0?(this.leftDown=!0,this.leftDownPos=this.mousePos,this.leftDownTime=new Date,this.leftPressed=!0):e.button===2&&(this.rightDown=!0,this.rightDownPos=this.mousePos,this.rightDownTime=new Date,this.rightPressed=!0)}),t.addEventListener("mouseup",e=>{e.preventDefault(),console.log("mouseup",e.type,e.button,e.buttons),e.button===0?(this.leftDown=!1,this.leftUpPos=this.mousePos,this.leftUpTime=new Date,this.leftClicked=!0,this.leftReleased=!0):e.button===2&&(this.rightDown=!1,this.rightUpPos=this.mousePos,this.rightUpTime=new Date,this.rightClicked=!0,this.rightReleased=!0)}),t.addEventListener("wheel",e=>{this.wheelDeltaTemp.add(new d(e.deltaX,e.deltaY)),e.target.scrollLeft=0,e.target.scrollTop=0}),t.addEventListener("mousewheel",e=>{e.preventDefault(),e.target.scrollLeft=0,e.target.scrollTop=0}),document.addEventListener("keydown",e=>{console.log("keydown",e.shiftKey,e.key,e.type,e.code),e.code==="ShiftLeft"&&(this.shiftDownTemp=!0)}),document.addEventListener("keyup",e=>{e.code==="ShiftLeft"&&(this.shiftDownTemp=!1)})}update(){this.firstUpdate=!1,this.leftClicked=!1,this.leftPressed=!1,this.leftReleased=!1,this.rightClicked=!1,this.rightPressed=!1,this.rightReleased=!1,this.mouseDelta.copy(this.mousePos).sub(this.mousePosPrevious),this.mousePosPrevious.copy(this.mousePos),this.wheelDelta.copy(this.wheelDeltaTemp),this.wheelDeltaTemp.set(0,0),this.shiftDown=this.shiftDownTemp}}var Rt="/assets/tileset.956e01e7.png",At="/assets/$Torus.0.colour.b0ea195e.png",Ct="/assets/$Torus.0.depth.44a76b80.png";class Lt{constructor(t){i(this,"_textureLoader");i(this,"_gltfLoader");i(this,"_onLoaded");i(this,"tileset");i(this,"cube_colour");i(this,"cube_depth");this._textureLoader=new Q,this._gltfLoader=new J,this._onLoaded=t,tt.onProgress=(e,o,s)=>{console.log(o,s,e),o==s&&this._onLoaded()},this.tileset=this._textureLoader.load(Rt),this.cube_colour=this._textureLoader.load(At),this.cube_depth=this._textureLoader.load(Ct)}}const u={t:{name:"t",direction:new d(0,-1)},b:{name:"b",direction:new d(0,1)},l:{name:"l",direction:new d(-1,0)},r:{name:"r",direction:new d(1,0)},tl:{name:"tl",direction:new d(-1,-1)},tr:{name:"tr",direction:new d(1,-1)},bl:{name:"bl",direction:new d(-1,1)},br:{direction:new d(1,1)}},T={};T[[u.t.direction.x,u.t.direction.y]]=u.t;T[[u.b.direction.x,u.b.direction.y]]=u.b;T[[u.l.direction.x,u.l.direction.y]]=u.l;T[[u.r.direction.x,u.r.direction.y]]=u.r;T[[u.tl.direction.x,u.tl.direction.y]]=u.tl;T[[u.tr.direction.x,u.tr.direction.y]]=u.tr;T[[u.bl.direction.x,u.bl.direction.y]]=u.bl;T[[u.br.direction.x,u.br.direction.y]]=u.br;const b=8;class zt{constructor(t,e){i(this,"pies");i(this,"_ctx");i(this,"resizeWindow",()=>{const t=this._ctx.canvas;let e=window.devicePixelRatio;t.style.width=`${window.innerWidth}px`,t.style.height=`${window.innerHeight}px`,t.width=window.innerWidth*e,t.height=window.innerHeight*e,this._ctx.scale(e,e)});i(this,"install",t=>{window.addEventListener("resize",this.resizeWindow),this.resizeWindow()});i(this,"update",(t,e,o,s)=>{if(this._ctx.lineWidth=1,o)if(this.pies.filter(r=>r.isOpen).length===0)this.pies[0].open(e);else for(const r of this.pies)r.isOpen&&r.onMouseDown(e);if(s)for(const r of this.pies)r.isOpen&&r.onMouseUp(e);for(const r of this.pies){const{isOpen:h,drawRadius:a,autoAcceptRadius:l,center:n,drawDirection:p}=r;h&&(this._ctx.fillStyle="purple",this._ctx.fillRect(n.x-b,n.y-b,b*2,b*2),this._ctx.strokeStyle="blue",this._ctx.beginPath(),this._ctx.ellipse(n.x,n.y,a,a,0,0,Math.PI*2),this._ctx.closePath(),this._ctx.stroke(),this._ctx.strokeStyle="silver",this._ctx.beginPath(),this._ctx.ellipse(n.x,n.y,l,l,0,0,Math.PI*2),this._ctx.closePath(),this._ctx.stroke(),r.items.map(_=>{switch(_.zone.type){case"direction":{const y=u[_.zone.value].direction.clone().normalize().multiplyScalar(a).add(n);this._ctx.fillStyle="blue",this._ctx.fillRect(y.x-b,y.y-b,b*2,b*2),this._ctx.font="12px sans-serif",this._ctx.textAlign="center";const f=this._ctx.measureText(_.name);this._ctx.fillStyle="#EEE",this._ctx.fillRect(y.x-f.actualBoundingBoxLeft-2,y.y+b-2,f.width+2,12+2),this._ctx.fillStyle="black",this._ctx.fillText(_.name,y.x,y.y+b*2);break}case"range":{const m=_.zone.from/180*Math.PI,y=_.zone.to/180*Math.PI,f=m+(y-m)/2,O=new d(Math.cos(f),Math.sin(f)),P=O.clone().multiplyScalar(a).add(n);if(this._ctx.fillStyle="lightgray",this._ctx.beginPath(),this._ctx.moveTo(n.x,n.y),this._ctx.ellipse(n.x,n.y,a*.9,a*.9,0,m,y),this._ctx.lineTo(n.x,n.y),this._ctx.closePath(),this._ctx.fill(),this._ctx.fillStyle="black",this._ctx.fillText(_.name,P.x,P.y-b),_.tickAngle!==void 0){const M=_.tickAngle/180*Math.PI;O.set(Math.cos(M),Math.sin(M)),P.copy(O).multiplyScalar(a).add(n),this._ctx.beginPath(),this._ctx.moveTo(n.x,n.y),this._ctx.lineTo(P.x,P.y),this._ctx.stroke()}break}}}),this._ctx.strokeStyle="blue",this._ctx.beginPath(),this._ctx.moveTo(n.x,n.y),this._ctx.lineTo(n.x+p.x*a,n.y+p.y*a),this._ctx.closePath(),this._ctx.stroke(),r.update(t,e))}for(const r of this.pies){if(r.isOpen)return x;r.drawRadius>0}return g});this.pies=t,this._ctx=e}}class Ot{constructor(t,e){i(this,"_element");i(this,"_element_immediate");i(this,"_element_log");i(this,"_element_activetool");i(this,"_immediate");i(this,"_immediate_previous");i(this,"_logsize");i(this,"_logdirty");i(this,"_log");i(this,"_activeTool");i(this,"_activeTool_dirty");i(this,"_arrows");i(this,"_cursor");i(this,"_cursordirty");i(this,"this");i(this,"_canvasCtx");this._immediate=[],this._log=[],this._logdirty=!1,this._activeTool="?",this._activeTool_dirty=!1,this._arrows=[],this._element=document.getElementById("app-hud"),this._canvasCtx=e,this._element_activetool=document.createElement("pre"),this._element_activetool.id="app-hud--activetool",this._element_activetool.className="boxy",this._element.appendChild(this._element_activetool),this._element_log=document.createElement("pre"),this._element_log.id="app-hud--log",this._element_log.className="boxy",this._element.appendChild(this._element_log),this._element_immediate=document.createElement("pre"),this._element_immediate.id="app-hud--immediate",this._element_immediate.className="boxy",this._element_immediate.style.minHeight="5em",this._element.appendChild(this._element_immediate),this._logsize=t;for(let o=0;o<t;o++){const s=document.createElement("pre");this._element_log.appendChild(s),this.logInfo(" ")}}setCursor(t){this._cursor=t,this._cursordirty=!0}setActiveTool(t){t!==this._activeTool&&(this._activeTool=t,this._activeTool_dirty=!0)}logInfo(t){for(this._log.push(t);this._log.length>this._logsize;)this._log.splice(0,1);this._logdirty=!0}showNow(t){this._immediate+=t+`
`}drawArrow(t,e){this._arrows.push([[t.x,t.y],[e.x,e.y]])}update(){for(this._logdirty&&(this._log.forEach((t,e)=>{this._element_log.children[e].innerText=t}),this._logdirty=!1),this._activeTool_dirty&&(this._element_activetool.innerText=this._activeTool,this._activeTool_dirty=!1),this._immediate!==this._immediate_previous&&(this._element_immediate.innerText=this._immediate,this._immediate_previous=this._immediate),this._cursordirty&&(document.body.style.cursor!==this._cursor&&(document.body.style.cursor=this._cursor),this._cursordirty=!1);this._arrows.length;){const[t,e]=this._arrows.pop(),[o,s]=t,[r,h]=e;this._canvasCtx.beginPath(),this._canvasCtx.moveTo(o,s),this._canvasCtx.lineTo(r,h),this._canvasCtx.strokeStyle="green",this._canvasCtx.stroke()}this._immediate=""}}class Bt{constructor(t,e,o){i(this,"_pieman");i(this,"_start");i(this,"getName",()=>"Pie Menu");i(this,"update",(t,e,{interactions:o,hud:s})=>{if(t)return g;const r=this._pieman.update(e,o.mousePos,o.leftPressed,o.leftReleased);return r===x?x:r===S?S:(s.logInfo("Pie close"),g)});this._start=e,this._pieman=o,o.update(1,e,!0,!1),t.logInfo("Pie open")}}class St{constructor(t,e){i(this,"_setNextTool");i(this,"_makeNewPanningTool");i(this,"getName",()=>"Idle");i(this,"update",(t,e,o)=>o.interactions.rightPressed?(this._setNextTool(new Bt(o.hud,o.interactions.mousePos,o.piemans)),g):o.interactions.leftPressed&&o.interactions.shiftDown?(this._setNextTool(this._makeNewPanningTool()),g):x);this._setNextTool=t,this._makeNewPanningTool=e}}class Nt{constructor(t){i(this,"_pan");i(this,"_dirtyCallback");i(this,"_firstUpdate");i(this,"_offset");i(this,"_zoom");i(this,"getName",()=>"Terraforming");i(this,"update",(t,e,{interactions:o,hud:s})=>t?g:this._firstUpdate?(this._firstUpdate=!1,x):o.rightDown===!0?(s.logInfo("dismiss terraforming brush"),g):o.leftDown&&!o.shiftDown?x:V);this._firstUpdate=!0}brushTerrain(t){if(t!==void 0){const e=Math.floor(t.point.x),o=Math.floor(t.point.z),s=this.grid.get(e,o)||0;this.grid.brush(new d(e,o),3,.05);const r=new w(e,s,o),h=r.clone().add(new w(1,.1,1));if(this.hitarrow.position.copy(t.point),this.hitcage.box.setFromPoints([r,h]),t.face){const a=t.point;this.hud.showNow(`${a.x.toFixed(2)} ${a.y.toFixed(2)} ${a.z.toFixed(2)}`),this.hud.showNow(`faceindex: ${t.faceIndex}`)}}}}class It{constructor(t,e,o,s,r){i(this,"_start");i(this,"_pan");i(this,"_dirtyCallback");i(this,"_firstUpdate");i(this,"_offset");i(this,"_zoom");i(this,"getName",()=>"Panning");i(this,"update",(t,e,{interactions:o,hud:s})=>t?g:this._firstUpdate?(this._firstUpdate=!1,x):o.leftPressed===!0?g:(this._offset.copy(this._start).sub(o.mousePos),this._offset.length()>5&&(this._pan.add(new d(-(this._offset.x*(.05/this._zoom))*e,-(this._offset.y*(.05/this._zoom))*e)),this._dirtyCallback()),s.drawArrow(this._start,o.mousePos),s.showNow(`pan: ${this._offset.x.toFixed(0)},${this._offset.y.toFixed(0)}`),x));this._start=e.clone(),this._pan=o,this._dirtyCallback=r,this._firstUpdate=!0,this._offset=new d,this._zoom=s,t.logInfo(`PanningTool from ${e.x},${e.y}`)}}function Et(c){return c<.5?c*c:1-Math.pow(-2*c+2,2)/2}function Mt(c){return c<.5?Math.sqrt(c):0-(Math.sqrt(-2*c+2)-2)/2}class A{constructor(t,e){i(this,"isOpen");i(this,"center");i(this,"radius");i(this,"autoAcceptRadius");i(this,"drawRadius");i(this,"direction");i(this,"drawDirection");i(this,"items");i(this,"activeItem");i(this,"open",t=>{this.center.copy(t),this.drawRadius=1,this.isOpen=!0});i(this,"close",()=>{this.isOpen=!1});i(this,"accept",t=>{if(console.log(this.activeItem),this.activeItem!==void 0&&this.activeItem.callback!==void 0){const e=this.direction.clone().normalize().multiplyScalar(this.drawRadius).add(this.center);this.activeItem.callback(e,t)}});i(this,"onMouseDown",t=>{this.center.distanceTo(t)>this.radius&&this.close()});i(this,"onMouseUp",t=>{this.center.distanceTo(t)>this.radius&&(this.accept(t),this.close())});i(this,"update",(t,e)=>{if(this.isOpen){this.drawRadius<this.radius&&(this.drawRadius=Math.min(this.radius,this.drawRadius+this.radius*t*9));const o=e.clone().sub(this.center),s=o.clone().normalize(),r=s.clone().round();this.direction=r,this.drawDirection=r.clone().normalize();const h=[r.x,r.y],a=T[h];if(a===void 0){console.log("undefined directionObject",h);return}const l=a.name;for(const n of this.items)switch(n.zone.type){case"direction":{if(n.zone.value!==l)continue;this.activeItem=n,this.direction=r,n.autoAccept&&o.length()>this.autoAcceptRadius&&(this.accept(e),this.close());break}case"range":{const p=Math.atan2(s.y,s.x),m=(p>=0?p:Math.PI*2-Math.abs(p))*(180/Math.PI);n.zone.from<=m&&n.zone.to>=m&&(this.activeItem=n,this.direction=s,this.drawDirection=s,n.rangeCallback&&n.rangeCallback(m),n.autoAccept&&o.length()>this.autoAcceptRadius&&(this.accept(e),this.close()));break}}}});this.isOpen=!1,this.center=new d(0,0),this.radius=t,this.autoAcceptRadius=e,this.drawRadius=1,this.items=[],this.direction=u.t.direction,this.drawDirection=u.t.direction}}const v=new A(91,110),C=new A(91,110),E=new A(91,110),L=new A(91,110);function Ut(c){L.items.push({name:"Back",zone:{type:"direction",value:"bl"},autoAccept:!0,callback:(a,l)=>v.open(l)}),L.items.push({name:"Height Brush",zone:{type:"direction",value:"r"},autoAccept:!0,callback:()=>{c.setNextActiveTool(new Nt(c.hud))}}),C.items.push({name:"AUTO Pan Tool",zone:{type:"direction",value:"t"},autoAccept:!0,callback:(a,l)=>{c.setNextActiveTool(new It(c.hud,l,c.cameraPan,c.orthozoom,c.resizeWindow))}}),C.items.push({name:"Back",zone:{type:"direction",value:"l"},autoAccept:!0,callback:(a,l)=>v.open(l)}),v.items.push({name:"Terrain tools",zone:{type:"direction",value:"tr"},autoAccept:!0,callback:(a,l)=>L.open(l)}),v.items.push({name:"Righty Ho",zone:{type:"direction",value:"r"},autoAccept:!0,callback:(a,l)=>C.open(l)}),v.items.push({name:"Lefty Yo",zone:{type:"direction",value:"l"},autoAccept:!0,callback:(a,l)=>E.open(l)}),v.items.push({name:"BotToppity Left",zone:{type:"direction",value:"bl"},autoAccept:!1,callback:()=>{}});const t=.05,e=2,o=200,s=340,r=140,h=()=>(c.orthozoom-t)/(e-t);E.items.push({get name(){return`Zoomy Zoom ${(h()*100).toFixed(0)}`},get tickAngle(){const a=h(),l=Mt(a),n=o+r*l;return c.hud.showNow(`tick: ${a.toFixed(2)} ${l.toFixed(2)} ${n.toFixed(1)}\xB0`),n},zone:{type:"range",from:o,to:s},autoAccept:!1,callback:()=>{},rangeCallback:a=>{const l=(a-o)/r;c.orthozoom=t+Et(l)*e,c.resizeWindow(),c.hud.showNow(`zoom: ${c.orthozoom}`),c.hud.showNow(`frustum: ${c.orthocam.left.toFixed(1)} ${c.orthocam.right.toFixed(1)}`)}})}class Ft{constructor(t,e){i(this,"loaded");i(this,"hud");i(this,"grid");i(this,"assets");i(this,"interactions");i(this,"activeBlock");i(this,"clock");i(this,"scene");i(this,"cameraPan");i(this,"orthocam");i(this,"orthozoom");i(this,"renderer");i(this,"composer");i(this,"renderp");i(this,"effectFXAA");i(this,"hitarrow");i(this,"hitcage");i(this,"element");i(this,"terrainRenderer");i(this,"objectSpriteRenderer");i(this,"axes");i(this,"perspectiveCamera");i(this,"piemans");i(this,"cameraHelper");i(this,"toolController");i(this,"terrainHit");i(this,"_hudCtx");i(this,"onLoaded",()=>{this.loaded=!0,this.terrainRenderer=new Dt(this.assets),this.scene.add(this.terrainRenderer.object3d),this.objectSpriteRenderer=new Pt(this.assets),this.scene.add(this.objectSpriteRenderer.object3d),Ut(this),this.element=document.querySelector("#app"),this.interactions.install(document),this.piemans.install(document),this.element.appendChild(this.renderer.domElement)});i(this,"resizeWindow",()=>{const t=innerWidth/innerHeight;this.cameraPan.y+this.orthozoom,this.orthocam.left=this.cameraPan.x+-1*t,this.orthocam.right=this.cameraPan.x+t,this.orthocam.top=this.cameraPan.y+-1,this.orthocam.bottom=this.cameraPan.y+1,this.orthocam.zoom=this.orthozoom,this.orthocam.updateProjectionMatrix(),this.cameraHelper.update()});i(this,"update",()=>{if(this.loaded===!1)return;const t=this.clock.getDelta();this.hud.setActiveTool(this.toolController.activeTool.getName()),this.hud.setCursor("default"),this.interactions.leftPressed&&this.hud.logInfo("LDown"),this.interactions.leftReleased&&this.hud.logInfo("LUp"),this.interactions.rightPressed&&this.hud.logInfo("RDown"),this.interactions.rightReleased&&this.hud.logInfo("RUp"),this.renderer.clear(),this._hudCtx.clearRect(0,0,innerWidth,innerHeight),this.renderer.setViewport(0,0,window.innerWidth,window.innerHeight),this.renderer.render(this.scene,this.orthocam),this.terrainRenderer.update(this.grid),this.objectSpriteRenderer.update(),this.renderer.setViewport(0,0,256,256),this.renderer.clearDepth(),this.renderer.render(this.scene,this.perspectiveCamera);const e=this.interactions.leftDownPos.x/this.element.clientWidth-1,o=0-this.interactions.leftDownPos.y/this.element.clientHeight,s=new w(e,o,0),r=new mt;this.orthocam.updateProjectionMatrix(),this.orthocam.updateMatrixWorld(),r.setFromCamera(s,this.orthocam),this.hud.showNow(`${s.x.toFixed(2)} ${s.y.toFixed(2)} ${s.z.toFixed(2)}`);const h=this.terrainRenderer.raycast(r);this.terrainHit=h[h.length-1],this.toolController.update(t,this),this.interactions.update(),this.hud.update()});i(this,"setNextActiveTool",t=>{this.toolController.setNextTool(t)});this.loaded=!1,this.assets=new Lt(this.onLoaded);const o=document.getElementById("app-canvas");this._hudCtx=o.getContext("2d"),this.hud=new Ot(15,this._hudCtx),this.toolController=new bt(_=>new St(_,()=>new Tt(this.hud,this.interactions.mousePos,this.cameraPan,this.orthozoom,window.innerWidth,this.orthocam.right-this.orthocam.left,this.resizeWindow))),this.clock=new et,this.scene=new it,this.activeBlock=1,this.cameraPan=new d(5,5),this.orthocam=new st(-1,1,1,-1,.01,50),this.orthocam.position.set(0,0,0),this.orthocam.rotateY(j(45)),this.orthocam.rotateX(-j(30)),this.orthocam.translateOnAxis(new w(0,0,1),10);const s=new ot(this.orthocam);this.cameraHelper=s,this.scene.add(s),this.perspectiveCamera=new rt,this.perspectiveCamera.position.setZ(50),this.orthozoom=.25,this.renderer=new nt;var r=window.innerWidth,h=window.innerHeight;this.renderer.setSize(r,h),this.renderer.setClearColor(gt),this.renderer.autoClear=!1,this.composer=new at(this.renderer),this.renderp=new ht(this.scene,this.orthocam),this.composer.addPass(this.renderp);var a=new ct(3359829);this.scene.add(a);var l=new lt(16777215,3,50,5);l.position.set(1,1,1),this.scene.add(l),this.hitarrow=new dt(new w(0,-1,0),new w,.5,B,.2,.2),this.scene.add(this.hitarrow),this.hitcage=new ut(new _t,B),this.scene.add(this.hitcage);const n=new ft(1);this.axes=n,n.position.set(0,.1,0),this.scene.add(n),n.setColors(B,xt,yt),n.translateX(.001),n.translateY(.001);const p=new pt(16,16);p.position.set(0,0,0),this.scene.add(p),this.grid=new vt(t,e);for(let _=4;_<7;_++)for(let m=4;m<8;m++)this.grid.data[_][m]=.5;this.interactions=new kt,this.piemans=new zt([v,C,E,L],this._hudCtx)}}const z=new Ft(32,32);window.game=z;window.addEventListener("resize",z.resizeWindow);z.resizeWindow();function X(){z.update(),requestAnimationFrame(X)}X();
